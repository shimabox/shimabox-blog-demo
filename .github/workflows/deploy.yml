name: Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'CLAUDE.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'CLAUDE.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'diff'
        type: choice
        options:
          - diff   # å·®åˆ†syncã—ã¦deploy
          - full   # å…¨ä»¶syncã—ã¦deploy
          - slug   # æŒ‡å®šslugã®ã¿syncã—ã¦deploy
          - deploy # deployã®ã¿ï¼ˆsyncãªã—ï¼‰
      slug:
        description: 'slugï¼ˆdeploy_type=slugã®å ´åˆã«æŒ‡å®šï¼‰'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # PRã®å ´åˆã¯Lintãƒ»å‹ãƒã‚§ãƒƒã‚¯
      - name: Lint and type check
        if: github.event_name == 'pull_request'
        run: npm run check

      # PRã®å ´åˆã¯å¤‰æ›´å†…å®¹ã‚’æ¤œå‡ºã—ã¦ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
      - name: Detect PR changes
        id: pr_changes
        if: github.event_name == 'pull_request'
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
          git fetch origin main --depth=1

          echo "=========================================="
          echo "ğŸ“‹ PR Content Changes Summary"
          echo "=========================================="

          # è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          ADDED=$(git -c core.quotepath=false diff --diff-filter=A --name-only origin/main...HEAD -- 'content/posts/*.md' 'content/pages/*.md' 'content/images/**' || true)
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          MODIFIED=$(git -c core.quotepath=false diff --diff-filter=M --name-only origin/main...HEAD -- 'content/posts/*.md' 'content/pages/*.md' 'content/images/**' || true)
          # å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          DELETED=$(git -c core.quotepath=false diff --diff-filter=D --name-only origin/main...HEAD -- 'content/posts/*.md' 'content/pages/*.md' 'content/images/**' || true)

          ADDED_COUNT=0
          MODIFIED_COUNT=0
          DELETED_COUNT=0
          ADDED_LIST=""
          MODIFIED_LIST=""
          DELETED_LIST=""

          # è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒªã‚¹ãƒˆåŒ–
          if [ -n "$ADDED" ]; then
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              ADDED_COUNT=$((ADDED_COUNT + 1))
              ADDED_LIST="$ADDED_LIST- \`$file\`\n"
              echo "â• Added: $file"
            done <<< "$ADDED"
          fi

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒªã‚¹ãƒˆåŒ–
          if [ -n "$MODIFIED" ]; then
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              MODIFIED_COUNT=$((MODIFIED_COUNT + 1))
              MODIFIED_LIST="$MODIFIED_LIST- \`$file\`\n"
              echo "ğŸ“ Modified: $file"
            done <<< "$MODIFIED"
          fi

          # å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒªã‚¹ãƒˆåŒ–
          if [ -n "$DELETED" ]; then
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              DELETED_COUNT=$((DELETED_COUNT + 1))
              DELETED_LIST="$DELETED_LIST- \`$file\`\n"
              echo "ğŸ—‘ï¸  Deleted: $file"
            done <<< "$DELETED"
          fi

          TOTAL=$((ADDED_COUNT + MODIFIED_COUNT + DELETED_COUNT))

          echo ""
          echo "Total: $TOTAL changes (Added: $ADDED_COUNT, Modified: $MODIFIED_COUNT, Deleted: $DELETED_COUNT)"
          echo "=========================================="

          # å‡ºåŠ›ã‚’è¨­å®š
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "modified_count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

          # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å‡ºåŠ›ç”¨ï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
          echo "added_list=$(echo -e "$ADDED_LIST" | base64 -w 0)" >> $GITHUB_OUTPUT
          echo "modified_list=$(echo -e "$MODIFIED_LIST" | base64 -w 0)" >> $GITHUB_OUTPUT
          echo "deleted_list=$(echo -e "$DELETED_LIST" | base64 -w 0)" >> $GITHUB_OUTPUT

      # å·®åˆ†syncï¼ˆpushæ™‚ or workflow_dispatch ã§ diff é¸æŠæ™‚ï¼‰â€»PRæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
      - name: Detect changed posts
        id: detect
        if: github.event_name == 'push' || github.event.inputs.deploy_type == 'diff'
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸmdãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºï¼ˆæ—¥æœ¬èªãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’é˜²ãï¼‰
          # å‰Šé™¤ä»¥å¤–ã®å¤‰æ›´ã®ã¿
          CHANGED_FILES=$(git -c core.quotepath=false diff --diff-filter=ACMRT --name-only HEAD~1 HEAD -- 'content/posts/*.md' 'content/pages/*.md' 'content/images/**' || true)

          # å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
          DELETED_FILES=$(git -c core.quotepath=false diff --diff-filter=D --name-only HEAD~1 HEAD -- 'content/posts/*.md' 'content/pages/*.md' 'content/images/**' || true)

          if [ -n "$DELETED_FILES" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸ—‘ï¸  Deleted files detected                                   â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "$DELETED_FILES"
            echo ""

            # content/ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦R2ãƒ‘ã‚¹ã«å¤‰æ›
            DELETED_R2_PATHS=""
            DELETED_SLUGS=""
            DELETED_COUNT=0
            # while read ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              # ã‚·ã‚§ãƒ«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–: å±é™ºãªæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¹ã‚­ãƒƒãƒ—
              if [[ "$file" =~ [\;\|\$\`\&\<\>\(\)\{\}\\] ]]; then
                echo "âš ï¸  Skipping file with dangerous characters: $file"
                continue
              fi
              r2_path="${file#content/}"
              DELETED_R2_PATHS="$DELETED_R2_PATHS $r2_path"
              DELETED_COUNT=$((DELETED_COUNT + 1))
              # è¨˜äº‹ã®å ´åˆã¯slugã‚’æŠ½å‡ºï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ç”¨ï¼‰
              if [[ "$file" == content/posts/*.md ]]; then
                filename=$(basename "$file" .md)
                slug=$(echo "$filename" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
                DELETED_SLUGS="$DELETED_SLUGS $slug"
              fi
            done <<< "$DELETED_FILES"
            echo "deleted_r2_paths=$DELETED_R2_PATHS" >> $GITHUB_OUTPUT
            echo "deleted_slugs=$DELETED_SLUGS" >> $GITHUB_OUTPUT
            echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
            echo "has_deletions=true" >> $GITHUB_OUTPUT
          else
            echo "has_deletions=false" >> $GITHUB_OUTPUT
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No content changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          SLUGS=""
          WARM_URLS=""

          add_slug() {
            local slug="$1"
            if [[ " $SLUGS " == *" $slug "* ]]; then
              return
            fi
            local md_file=$(find content/posts -name "*-${slug}.md" 2>/dev/null | head -1)
            if [ -n "$md_file" ]; then
              local filename=$(basename "$md_file" .md)
              local date_part=$(echo "$filename" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
              if [ -n "$date_part" ]; then
                local year=$(echo "$date_part" | cut -d'-' -f1)
                local month=$(echo "$date_part" | cut -d'-' -f2)
                local day=$(echo "$date_part" | cut -d'-' -f3)
                SLUGS="$SLUGS $slug"
                WARM_URLS="$WARM_URLS /$year/$month/$day/$slug/"
              fi
            fi
          }

          # while read ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            # ã‚·ã‚§ãƒ«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–: å±é™ºãªæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¹ã‚­ãƒƒãƒ—
            if [[ "$file" =~ [\;\|\$\`\&\<\>\(\)\{\}\\] ]]; then
              echo "âš ï¸  Skipping file with dangerous characters: $file"
              continue
            fi
            if [[ "$file" == content/posts/*.md ]]; then
              # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰slugã‚’æŠ½å‡º
              filename=$(basename "$file" .md)
              slug=$(echo "$filename" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
              date_part=$(echo "$filename" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
              year=$(echo "$date_part" | cut -d'-' -f1)
              month=$(echo "$date_part" | cut -d'-' -f2)
              day=$(echo "$date_part" | cut -d'-' -f3)
              SLUGS="$SLUGS $slug"
              WARM_URLS="$WARM_URLS /$year/$month/$day/$slug/"
            elif [[ "$file" == content/images/* ]]; then
              image_path="/${file#content/}"
              echo "Looking for posts referencing: $image_path"

              # grepã§ç”»åƒã‚’å‚ç…§ã—ã¦ã„ã‚‹è¨˜äº‹ã‚’æ¤œç´¢
              while IFS= read -r md; do
                [ -z "$md" ] && continue
                ref_filename=$(basename "$md" .md)
                ref_slug=$(echo "$ref_filename" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
                echo "Found referencing post: $ref_slug"
                add_slug "$ref_slug"
              done < <(grep -l "$image_path" content/posts/*.md 2>/dev/null || true)
            fi
          done <<< "$CHANGED_FILES"

          echo "slugs=$SLUGS" >> $GITHUB_OUTPUT
          echo "warm_urls=$WARM_URLS" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Sync changed content to R2
        id: sync
        if: (github.event_name == 'push' || github.event.inputs.deploy_type == 'diff') && steps.detect.outputs.has_changes == 'true'
        run: |
          SLUGS="${{ steps.detect.outputs.slugs }}"
          SYNCED_SLUGS=""

          if [ -n "$SLUGS" ]; then
            for slug in $SLUGS; do
              echo "Syncing: $slug"
              npm run sync -- "$slug"
              SYNCED_SLUGS="$SYNCED_SLUGS $slug"
            done
          fi

          echo "synced_slugs=$SYNCED_SLUGS" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’R2ã‹ã‚‰å‰Šé™¤
      - name: Delete removed files from R2
        if: (github.event_name == 'push' || github.event.inputs.deploy_type == 'diff') && steps.detect.outputs.has_deletions == 'true'
        run: |
          DELETED_R2_PATHS="${{ steps.detect.outputs.deleted_r2_paths }}"

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ—‘ï¸  Deleting files from R2                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          npm run sync -- --delete-paths $DELETED_R2_PATHS
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # å…¨ä»¶syncï¼ˆworkflow_dispatch ã§ full é¸æŠæ™‚ï¼‰
      - name: Sync all content to R2 (with delete)
        if: github.event.inputs.deploy_type == 'full'
        run: npm run sync -- --delete
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SITE_URL: ${{ secrets.SITE_URL }}
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}

      - name: Sync specified slug to R2
        id: sync_slug
        if: github.event.inputs.deploy_type == 'slug' && github.event.inputs.slug != ''
        run: |
          SLUG="${{ github.event.inputs.slug }}"
          echo "Syncing specified slug: $SLUG"
          npm run sync -- "$SLUG"
          echo "synced_slugs=$SLUG" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Pages
        id: deploy
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%s | iconv -c -f UTF-8 -t ASCII//TRANSLIT || echo "deploy")

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="pr-${{ github.event.pull_request.number }}"
            npx wrangler pages deploy ./public --branch="$BRANCH_NAME" --commit-message="$COMMIT_MSG"
          else
            npx wrangler pages deploy ./public --commit-message="$COMMIT_MSG"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # PRã«å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment changes on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const addedCount = parseInt('${{ steps.pr_changes.outputs.added_count }}') || 0;
            const modifiedCount = parseInt('${{ steps.pr_changes.outputs.modified_count }}') || 0;
            const deletedCount = parseInt('${{ steps.pr_changes.outputs.deleted_count }}') || 0;
            const totalCount = addedCount + modifiedCount + deletedCount;

            // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
            const decodeBase64 = (str) => {
              if (!str) return '';
              try {
                return Buffer.from(str, 'base64').toString('utf-8').trim();
              } catch {
                return '';
              }
            };

            const addedList = decodeBase64('${{ steps.pr_changes.outputs.added_list }}');
            const modifiedList = decodeBase64('${{ steps.pr_changes.outputs.modified_list }}');
            const deletedList = decodeBase64('${{ steps.pr_changes.outputs.deleted_list }}');

            let body = 'ğŸ“‹ **Content Changes**\n\n';

            if (totalCount > 0) {
              if (addedCount > 0) {
                body += `<details>\n<summary>â• Added (${addedCount})</summary>\n\n${addedList}\n</details>\n\n`;
              }

              if (modifiedCount > 0) {
                body += `<details>\n<summary>ğŸ“ Modified (${modifiedCount})</summary>\n\n${modifiedList}\n</details>\n\n`;
              }

              if (deletedCount > 0) {
                body += `<details>\n<summary>ğŸ—‘ï¸ Deleted (${deletedCount})</summary>\n\n${deletedList}\n</details>\n\n`;
              }
            } else {
              body += '_No content file changes detected._\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆPRæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      - name: Invalidate cache
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_type != 'deploy')
        run: |
          # å·®åˆ†syncã¾ãŸã¯slugæŒ‡å®šsyncã®çµæœã‚’å–å¾—
          SYNCED_SLUGS="${{ steps.sync.outputs.synced_slugs }}${{ steps.sync_slug.outputs.synced_slugs }}"
          # å‰Šé™¤ã•ã‚ŒãŸslugã‚’è¿½åŠ 
          DELETED_SLUGS="${{ steps.detect.outputs.deleted_slugs }}"
          ALL_SLUGS="$SYNCED_SLUGS $DELETED_SLUGS"

          # full sync ã®å ´åˆã¯å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
          if [ "${{ github.event.inputs.deploy_type }}" == "full" ]; then
            echo "Invalidating all cache"
            curl -X POST "${{ secrets.SITE_URL }}/api/invalidate" \
              -H "X-Admin-Key: ${{ secrets.ADMIN_KEY }}" \
              --fail-with-body || echo "Cache invalidation failed"
          elif [ -n "$ALL_SLUGS" ]; then
            # å·®åˆ†syncã®å ´åˆã¯å€‹åˆ¥ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼ˆåŒæœŸã•ã‚ŒãŸslug + å‰Šé™¤ã•ã‚ŒãŸslugï¼‰
            for slug in $ALL_SLUGS; do
              echo "Invalidating cache for: $slug"
              # æ—¥æœ¬èªslugã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
              ENCODED_SLUG=$(printf '%s' "$slug" | jq -sRr @uri)
              curl -X POST "${{ secrets.SITE_URL }}/api/invalidate?slug=$ENCODED_SLUG" \
                -H "X-Admin-Key: ${{ secrets.ADMIN_KEY }}" \
                --fail-with-body || echo "Cache invalidation failed for $slug"
            done
          else
            echo "No cache invalidation needed"
          fi

      - name: Warm cache
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_type != 'deploy')
        run: |
          BASE_URL="${{ secrets.SITE_URL }}"

          if [ -z "$BASE_URL" ]; then
            echo "SITE_URL secret is not set, skipping warm"
            exit 0
          fi

          echo "Warming: $BASE_URL/"
          curl -s "$BASE_URL/" > /dev/null || echo "Failed to warm top page"

          WARM_URLS="${{ steps.detect.outputs.warm_urls }}"

          if [ "${{ github.event.inputs.deploy_type }}" == "slug" ] && [ -n "${{ github.event.inputs.slug }}" ]; then
            SLUG="${{ github.event.inputs.slug }}"
            MD_FILE=$(find content/posts -name "*-${SLUG}.md" 2>/dev/null | head -1)
            if [ -n "$MD_FILE" ]; then
              FILENAME=$(basename "$MD_FILE" .md)
              DATE_PART=$(echo "$FILENAME" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
              if [ -n "$DATE_PART" ]; then
                YEAR=$(echo "$DATE_PART" | cut -d'-' -f1)
                MONTH=$(echo "$DATE_PART" | cut -d'-' -f2)
                DAY=$(echo "$DATE_PART" | cut -d'-' -f3)
                WARM_URLS="/$YEAR/$MONTH/$DAY/$SLUG/"
              fi
            fi
          fi

          if [ -n "$WARM_URLS" ]; then
            for url in $WARM_URLS; do
              echo "Warming: ${BASE_URL}${url}"
              curl -s "${BASE_URL}${url}" > /dev/null || echo "Failed to warm $url"
            done
          fi
